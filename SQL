--Question1: Produce a SQL Statement that joins all the tables to get the product name, product number and PurchaseTrans

SELECT PT.TransID, PT.OrderID, CONVERT(Date,PT.OrderDate) OrderDate, CONVERT(date,PT.ShipDate) ShipDate, CONVERT(date,PT.DueDate) DueDate,
		PT.Supplier, PT.Country,
		PT.StateProvince, PT.City, PT.PostalCode, PT.CarrierTrackingNumber, P.ProductName, P.ProductNumber,PT.Class, PT.Color, PT.Employee,
		PT.OrderQty, PT.UnitPrice, PT.UnitPriceDiscount
FROM PurchaseTrans PT
INNER JOIN Product P ON P.ProductID = PT.ProductID



--Question2: Top 10 products ordered in each country on specific date with product detail including product category and net amount

WITH CTE AS (
				SELECT ROW_NUMBER() OVER(partition by Country order by AGGNetPurchaseAmount desc) RankID, a.OrderDate, a.Country, a.ProductName,
				a.CategoryName, FORMAT(isnull(a.AGGNetPurchaseAmount,0),'C') AGGNetPurchaseAmount
				FROM (
						SELECT CONVERT(Date,PT.OrderDate) OrderDate, PT.Country, P.ProductName, C.CategoryName,
										SUM((PT.UnitPrice*PT.OrderQty)-((PT.UnitPrice*PT.OrderQty)*PT.UnitPriceDiscount)) AGGNetPurchaseAmount
						FROM PurchaseTrans PT
						INNER JOIN Product P ON P.ProductID = PT.ProductID
						INNER JOIN ProductCategory PC ON PC.ProductID = P.ProductID
						INNER JOIN Category C ON C.CategoryID = PC.CategoryID
						GROUP BY PT.OrderDate, PT.Country, P.ProductName, C.CategoryName
					) a
			)

SELECT * FROM CTE
WHERE RankID <= 10



--Question3: List of suppliers that offer discount amount on purchased products filtered by Product Category

SELECT PT.Supplier, C.CategoryName
FROM PurchaseTrans PT
INNER JOIN Product P ON P.ProductID = PT.ProductID
INNER JOIN ProductCategory PC ON PC.ProductID = P.ProductID
INNER JOIN Category C ON C.CategoryID = PC.CategoryID
WHERE UnitPriceDiscount > 0
GROUP BY PT.Supplier, C.CategoryName



/*
Question4:
Create KPI with Low, Medium, High indicator based on Net Purchase Amount with the following
conditions:
- If the Net Purchase Amount is less than $10,000 then “Low”
- If the Net Purchase Amount between $10,000 and $20,000 then “Medium”
- If the Net Purchase Amount greater than $20,000 then “HIGH”
*/

SELECT PT.Country, C.CategoryName, P.ProductName, 
		FORMAT(isnull(SUM((PT.UnitPrice*PT.OrderQty)-((PT.UnitPrice*PT.OrderQty)*PT.UnitPriceDiscount)),0),'C') AGGNetPurchaseAmount,
		CASE
			WHEN SUM((PT.UnitPrice*PT.OrderQty)-((PT.UnitPrice*PT.OrderQty)*PT.UnitPriceDiscount)) < 10000 THEN 'Low'
			WHEN SUM((PT.UnitPrice*PT.OrderQty)-((PT.UnitPrice*PT.OrderQty)*PT.UnitPriceDiscount)) between 10000 and 20000 THEN 'Medium'
			WHEN SUM((PT.UnitPrice*PT.OrderQty)-((PT.UnitPrice*PT.OrderQty)*PT.UnitPriceDiscount)) > 20000 THEN 'High'

			END as KPI
FROM PurchaseTrans PT
INNER JOIN Product P ON P.ProductID = PT.ProductID
INNER JOIN ProductCategory PC ON PC.ProductID = P.ProductID
INNER JOIN Category C ON C.CategoryID = PC.CategoryID
GROUP BY PT.Country, C.CategoryName, P.ProductName

